name: API Build and push to ACR

on:
    push:
        branches:
        - main
        paths:
        - "src/api/**"
        - ".github/workflows/api-build-push.yml"
    workflow_dispatch:

env:
    IMAGE_NAME: cloud-doc-api

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Login to Azure Container Registry
              uses: azure/docker-login@v2
              with:
                login-server: ${{ secrets.ACR_LOGIN_SERVER }}
                username: ${{ secrets.ACR_USERNAME }}
                password: ${{ secrets.ACR_PASSWORD }}

            - name: Docker Build
              uses: docker/build-push-action@v6
              with:
                context: ./src/api
                push: true
                tags: |
                    ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                    ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

